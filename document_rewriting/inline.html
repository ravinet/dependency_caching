<script>
if ( _document != undefined ) {
} else {
    function get_caller(caller){
        var script_attributes = "";
        if ( caller == null ) {
            longname = window.location.pathname;
            if ( longname == "/" ) {
                script_attributes = "/";
            } else {
                script_attributes = longname.split('/').pop();
            }
            if ( script_attributes == "" ) {
                script_attributes = "event_handler_or_callback";
            }
        } else {
            var attr = caller.attributes;
            if( attr.length == 0 ) {
                longname = window.location.pathname;
                if ( longname == "/" ) {
                    script_attributes = "/";
                } else {
                    script_attributes = longname.split('/').pop();
                }
                if ( script_attributes == "" ) {
                    script_attributes = "inline_script";
                }
            } else {
                for(j=0; j < attr.length; j++) {
                    if( attr[j].name == "src" ) {
                        script_attributes = script_attributes.concat( attr[j].value );
                    }
                    if ( script_attributes == "" ) {
                        script_attributes = window.location.pathname;
                    }
                }
            }
        }
        return script_attributes;
    }

    function list_properties(properties){
        var props = "";
        for (var key in properties){
            props = props.concat(key + ":" + properties[key] + ", ");
        }
        props = props.slice(0, props.length-2);
        return props;
    }

    function list_properties_array(properties){
        var props = "";
        for (j = 0; j < properties.length; j++){
            var arr = properties[j];
            for (i = 0; i < arr.length; i++){
                props = props.concat(arr[i] + ", ");
            }
            props = props.slice(0, props.length-2);
            props = props + ";";
        }
        props = props.slice(0, props.length-1);
        return props;
    }

    function print_single_attr(child_attributes){
        if ( child_attributes == null ) {
            return "";
        }
        var final_attributes = "";
        for (y=0; y<child_attributes.length; y++){
            final_attributes = final_attributes.concat(child_attributes[y] + "; ");
        }
        final_attributes = final_attributes.slice(0, final_attributes.length-2);
        return final_attributes;
    }

    function print_multiple_attr(child_attributes){
        if ( child_attributes == null ) {
            return "";
        }
        var final_attributes = "";
        for (var key in child_attributes){
            final_attributes = final_attributes.concat(key + "-");
            var current_attributes = child_attributes[key];
            for (y=0; y<current_attributes.length; y++){
                final_attributes = final_attributes.concat(current_attributes[y] + "; ");
            }
        }
        final_attributes = final_attributes.slice(0, final_attributes.length-2);
        return final_attributes;
    }

    function print_nodes(parents){
        var nodes = "";
        for (var key in parents) {
            nodes = nodes.concat(key +",");
        }
        nodes = nodes.slice(0, nodes.length-1);
        return nodes;
    }

    function get_child_path(curr){
        if ( curr == null ) {
            return [null, null];
        }
        child_path = [];
        child_path_tags = [];
        while ( curr.parentNode != null ) {
           var children = curr.parentNode.children;
           for (j = 0; j < children.length; j++){
               if( children[j] == curr ){
                   child_path.push(j);
                   child_path_tags.push(children[j].tagName);
               }
           }
           curr = curr.parentNode;
        }
        return [child_path, child_path_tags];
    }

    function get_multi_child_path(retVal){
        if ( retVal == null ) {
            return [null, null];
        }
        curr = retVal;
        parents = {};
        child_paths = {};
        child_paths_no_id = [];
        child_path_tags_no_id = [];
        child_path_tags = {};
        child_path_attr = {};
        for (i = 0; i < retVal.length; i++) {
            curr_child_path = [];
            curr_child_path_tags = [];
            curr_parents = [];
            curr_child_path_attr = [];
            curr = retVal[i];
            while ( curr.parentNode != null ) {
                curr_parents.push(curr.parentNode.id);
                var children = curr.parentNode.children;
                for (j = 0; j < children.length; j++){
                    if( children[j] == curr ){
                        curr_child_path.push(j);
                        curr_child_path_tags.push(children[j].tagName);
                        var attr = children[j].attributes;
                        var attributes = [];
                        for( a=0; a<attr.length; a++){
                            attributes.push(attr[a].name + ":" + attr[a].value);
                        }
                        curr_child_path_attr.push(attributes);
                    }
                }
                curr = curr.parentNode;
            }
            parents[retVal[i].id] = curr_parents;
            child_paths[retVal[i].id] = curr_child_path;
            child_paths_no_id.push(curr_child_path);
            child_path_tags[retVal[i].id] = curr_child_path_tags;
            child_path_tags_no_id.push(curr_child_path_tags);
            child_path_attr[retVal[i].id] = curr_child_path_attr;
        }
        ret = [child_paths_no_id, child_path_tags_no_id];
        return ret;
    }

    // id counter for DOM nodes
    window.proxy_counter = 0;

    // list of Node.prototype functions which we wrap (don't need proxies to log)
    var wrapped_functions = ["appendChild", "replaceChild", "removeChild", "insertBefore", "hasOwnProperty",
                             "compareDocumentPosition", "cloneNode", "contains", "hasChildNodes",
                             "isDefaultNamespace", "isEqualNode", "lookupNamespaceURI", "normalize",
                             "getElementsByClassName"];

    // proxy to track recursive reads/writes for DOM nodes
    node_handler = {
        "get": function(base, name){
                    var value = base[name];
                    var caller = get_caller(document.currentScript);
                    if ( (name != "_base") && (name != "_id")  && (wrapped_functions.indexOf(name) == -1) ) {
                        console.log("READ on DOM node with ID: " + base._id + " from: " + caller);
                    }
                    return value;
        },
        "set": function(base, name, value){
                    base[name] = value;
                    var caller = get_caller(document.currentScript);
                    console.log("WRITE to DOM node with ID: " + base._id + " from: " + caller);
        }
    };

    // proxy to track offsetNode calls to caretPositions
    caret_handler = {
        "get": function(base, name){
                    var value = base[name];
                    var caller = get_caller(document.currentScript);
                    if ( name == "offsetNode" ) {
                        var p = wrap_node_in_proxy(value);
                        console.log("READ on DOM node from caretPosition: ret_id=" + p[1] + " from: " + caller);
                        return p[0];
                    }
                    return value;
        }
    };

    // handler for NodeLists
    nodelist_handler = {
        "get": function(base, index){
                    var value = base[index];
                    var caller = get_caller(document.currentScript);
                    if ( index == "hasOwnProperty" ) {
                        return value;
                    }
                    if ( typeof(value) == "function" ) {
                        var functionproxy = function(i) {
                            var caller = get_caller(document.currentScript);
                            var this_val = this;
                            if ( this.hasOwnProperty("_base") ) {
                                this_val = this._base;
                            }
                            var retVal = value.call(this_val, i);
                            if ( retVal == null ) {
                                return retVal;
                            } else {
                                var p = wrap_node_in_proxy(retVal);
                                console.log( "Call to NodeList.item() in " + caller + "arg=" + i + "; ret_id = " + p[1]);
                                return p[0];
                            }
                       };
                       return functionproxy;
                    } else {
                        if ( (index != "_base") && (index != "_id")  && (wrapped_functions.indexOf(index) == -1) && (typeof(value) == "object")) {
                            var p = wrap_node_in_proxy(value);
                            console.log("Read from NodeList: index=" + index + " from: " + caller + "; ret_id: " + p[1]);
                            return p[0];
                        }
                        return value;
                    }
        }
    };

    // handler for NodeIterators
    iterator_nodeprops = ["referenceNode", "root"];
    nodeiterator_handler = {
        "get": function(base, name){
                    var value = base[name];
                    var caller = get_caller(document.currentScript);
                    if ( name == "hasOwnProperty" ) {
                        return value;
                    }
                    if ( typeof(value) == "function" ) {
                        var functionproxy = function() {
                            var caller = get_caller(document.currentScript);
                            var this_val = this;
                            if ( this.hasOwnProperty("_base") ) {
                                this_val = this._base;
                            }
                            var retVal = value.call(this_val);
                            if ( retVal == null ) {
                                return retVal;
                            } else {
                                var p = wrap_node_in_proxy(retVal);
                                console.log( "Call to NodeIterator method in " + caller + "; ret_id = " + p[1]);
                                return p[0];
                            }
                       };
                       return functionproxy;
                    } else {
                        if ( (iterator_nodeprops.indexOf(name) != -1 ) && (typeof(value) == "object")) {
                            var p = wrap_node_in_proxy(value);
                            console.log("READ on DOM node from node iterator: ret_id=" + p[1] + " from: " + caller);
                            return p[0];
                        }
                        return value;
                    }
        }
    };

    function wrap_node_in_proxy(domnode) {
        // maybe check if it is an element?
        // if it has id, return
        if ( domnode == null ) {
            return [domnode, "null"];
        }
        if ( domnode.hasOwnProperty("_id") ) {
            var retnode = new Proxy( domnode, node_handler );
            return [retnode, domnode._id];
        }

        // it is not already a proxy!
        var p = new Proxy(domnode, node_handler);
        Object.defineProperty(p, '_base', {
            enumerable: false,
            configurable: false,
            writable: false,
            value: domnode
        });
        Object.defineProperty(p, '_id', {
            enumerable: false,
            configurable: false,
            writable: false,
            value: window.proxy_counter
        });
        var ret = [p, window.proxy_counter];
        window.proxy_counter++;
        return ret;
    }

    var _appendChild = Node.prototype.appendChild;
    Node.prototype.appendChild = function(child){
                                     // add child as child to this in DOM tree (return added child)
                                     var arg1_val = child;
                                     var arg1_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( child.hasOwnProperty("_id") ) {
                                         arg1_id = child._id;
                                         arg1_val = child._base;
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling appendChild on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _appendChild.call(this_val, arg1_val);
                                     var p = wrap_node_in_proxy(retVal);
                                     console.log( "Call to Node.prototype.appendChild() in " + caller + "; arg=" +
                                                  arg1_id + "; node_modified=" + this_id + ": child_path=" +
                                                  child_vals[0] + "; child_path_tags=" + child_vals[1] + "; ret_id=" + p[1]);
                                     return p[0];
                                 };

    var _removeChild = Node.prototype.removeChild;
    Node.prototype.removeChild = function(child){
                                     // remove child from this in DOM tree (return removed child)
                                     var arg1_val = child;
                                     var arg1_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( child.hasOwnProperty("_id") ) {
                                         arg1_id = child._id;
                                         arg1_val = child._base;
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling removeChild on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _removeChild.call(this_val, arg1_val);
                                     var p = wrap_node_in_proxy(retVal);
                                     console.log( "Call to Node.prototype.removeChild() in " + caller + "; arg_id="+ arg1_id +
                                                  "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1] + "; ret_id = " + p[1]);
                                     return p[0];
                                 };

    var _replaceChild = Node.prototype.replaceChild;
    Node.prototype.replaceChild = function(newchild, oldchild){
                                     // replace oldchild with newchild as child to this in DOM tree (return removed node)
                                     var arg1_val = newchild;
                                     var arg1_id = "null";
                                     var arg2_val = oldchild;
                                     var arg2_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( newchild.hasOwnProperty("_id") ) {
                                         arg1_id = newchild._id;
                                         arg1_val = newchild._base;
                                     }
                                     if ( oldchild.hasOwnProperty("_id") ) {
                                         arg2_id = oldchild._id;
                                         arg2_val = oldchild._base;
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling replaceChild on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _replaceChild.call(this_val, arg1_val, arg2_val);
                                     var p = wrap_node_in_proxy(retVal);
                                     console.log( "Call to Node.prototype.replaceChild() in " + caller + "; arg_ids=" + arg1_id +
                                                  "," + arg2_id + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1] + "; ret_id = " + p[1]);
                                     return p[0];
                                 };

    var _insertBefore = Node.prototype.insertBefore;
    Node.prototype.insertBefore = function(newchild, referencechild){
                                     // insert newchild before oldchild as child to this in DOM tree (return added node)
                                     var arg1_val = newchild;
                                     var arg1_id = "null";
                                     var arg2_val = referencechild;
                                     var arg2_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( newchild.hasOwnProperty("_id") ) {
                                         arg1_id = newchild._id;
                                         arg1_val = newchild._base;
                                     }
                                     if ( referencechild == undefined ) {
                                         arg2_val = null;
                                     } else {
                                         if ( referencechild.hasOwnProperty("_id") ) {
                                             arg2_id = referencechild._id;
                                             arg2_val = referencechild._base;
                                         }
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling insertBefore on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _insertBefore.call(this_val, arg1_val, arg2_val);
                                     var p = wrap_node_in_proxy(retVal);
                                     console.log( "Call to Node.prototype.insertBefore() in " + caller + "; arg_ids="+ arg1_id
                                                  + "," + arg2_id + "; node_modified=" + this_id + ": child_path=" +
                                                  child_vals[0] + "; child_path_tags=" + child_vals[1] + "; ret_id=" + p[1]);
                                     return p[0];
                                 };

    var _compareDocumentPosition = Node.prototype.compareDocumentPosition;
    Node.prototype.compareDocumentPosition = function(comparenode){
                                     // compare document position of 'this' node and comparenode (return bitmask)
                                     var arg1_val = comparenode;
                                     var arg1_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( comparenode.hasOwnProperty("_id") ) {
                                         arg1_id = comparenode._id;
                                         arg1_val = comparenode._base;
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling compareDocumentPosition on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _compareDocumentPosition.call(this_val, arg1_val);
                                     console.log( "Call to Node.prototype.compareDocumentPosition() in " + caller + "; arg_ids="+
                                                  arg1_id + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _cloneNode = Node.prototype.cloneNode;
    Node.prototype.cloneNode = function(deep){
                                     // clone node and return new copy (copy not added to tree)
                                     var arg1_val = deep;
                                     if ( deep == undefined ) {
                                         arg1_val = false;
                                     }
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling cloneNode on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _cloneNode.call(this_val, arg1_val);
                                     console.log( "Call to Node.prototype.cloneNode() in " + caller + "; arg="+
                                                  arg1_val + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _contains = Node.prototype.contains;
    Node.prototype.contains = function(othernode){
                                     // checks whether othernode is descendant of this in DOM tree (returns bool)
                                     var arg1_val = othernode;
                                     var arg1_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( othernode.hasOwnProperty("_id") ) {
                                         arg1_id = othernode._id;
                                         arg1_val = othernode._base;
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling contains on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _contains.call(this_val, arg1_val);
                                     console.log( "Call to Node.prototype.contains() in " + caller + "; arg_id="+ arg1_id +
                                                  "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _hasChildNodes = Node.prototype.hasChildNodes;
    Node.prototype.hasChildNodes = function(){
                                     // checks whether this has children in DOM tree (returns bool)
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling hasChildNodes on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _hasChildNodes.call(this_val);
                                     console.log( "Call to Node.prototype.hasChildNodes() in " + caller + "; node_modified=" +
                                                  this_id + ": child_path=" + child_vals[0] + "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _isDefaultNamespace = Node.prototype.isDefaultNamespace;
    Node.prototype.isDefaultNamespace = function(namespaceURI){
                                     // checks whether namespace is default namespace for this node (returns bool)
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling isDefaultNamespace on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _isDefaultNamespace.call(this_val, namespaceURI);
                                     console.log( "Call to Node.prototype.isDefaultNamespace() in " + caller + "; arg="+
                                                  namespaceURI + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _isEqualNode = Node.prototype.isEqualNode;
    Node.prototype.isEqualNode = function(comparenode){
                                     // tests whether comparenode and this node are equal (return bool)
                                     var arg1_val = comparenode;
                                     var arg1_id = "null";
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( comparenode.hasOwnProperty("_id") ) {
                                         arg1_id = comparenode._id;
                                         arg1_val = comparenode._base;
                                     }
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling isEqualNode on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _isEqualNode.call(this_val, arg1_val);
                                     console.log( "Call to Node.prototype.isEqualNode() in " + caller + "; arg_ids="+
                                                  arg1_id + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _lookupNamespaceURI = Node.prototype.lookupNamespaceURI;
    Node.prototype.lookupNamespaceURI = function(prefix){
                                     // finds namespaceURI associated with prefix on this node (returns namespaceURI)
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling lookupNamespaceURI on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _lookupNamespaceURI.call(this_val, prefix);
                                     console.log( "Call to Node.prototype.lookupNamespaceURI() in " + caller + "; arg="+
                                                  prefix + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _lookupPrefix = Node.prototype.lookupPrefix;
    Node.prototype.lookupPrefix = function(namespaceURI){
                                     // finds DOMString associated with prefix on this node (returns prefix)
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling lookupPrefix on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _lookupPrefix.call(this_val, namespaceURI);
                                     console.log( "Call to Node.prototype.lookupPrefix in " + caller + "; arg="+
                                                  namespaceURI + "; node_modified=" + this_id + ": child_path=" + child_vals[0] +
                                                  "; child_path_tags=" + child_vals[1]);
                                     return retVal;
                                 };

    var _normalize = Node.prototype.normalize;
    Node.prototype.normalize = function(){
                                     // puts this and its subtree into normal form (no return value)
                                     var this_id = "null";
                                     var this_val = this;
                                     if ( this.hasOwnProperty("_id") ) {
                                         this_id = this._id;
                                         this_val = this._base;
                                     } else {
                                         console.log( "Calling normalize on DOM node which is not proxy" );
                                     }
                                     var caller = get_caller(document.currentScript);
                                     var child_vals = get_child_path(this_val);
                                     var retVal = _normalize.call(this_val);
                                     console.log( "Call to Node.prototype.normalize in " + caller + "; node_modified=" + this_id
                                                  + ": child_path=" + child_vals[0] + "; child_path_tags=" + child_vals[1]);
                                 };


    // START DOCUMENT SHIMS


    var _getElementById = document.getElementById;
    document.getElementById = function(requested_id){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _getElementById.call(document, requested_id);
                                  child_vals = get_child_path(retVal);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.getElementById() in " + caller + "; args="+ requested_id  +
                                  "; returned_node_child_path=" + child_vals[0] + "; child_path_tags=" + child_vals[1]
                                  + "; ret_id = " + p[1]);
                                  return p[0];
                              };


    var _querySelector = document.querySelector;
    document.querySelector = function(requested_selectors){
                                  // log the method name, argument (selector name), returned list of children (path for each)
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _querySelector.call(document, requested_selectors);
                                  child_vals = get_child_path(retVal);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.querySelector() in " + caller + "; args="+ requested_selectors  +
                                  "; returned_node_child_path=" + child_vals[0] + "; child_path_tags=" + child_vals[1]
                                  + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _getElementsByName = document.getElementsByName;
    document.getElementsByName = function(requested_name){
                                  // log the method name, argument (name), returned list of children (path for each)
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _getElementsByName.call(document, requested_name);
                                  var ret = get_multi_child_path(retVal);
                                  // wrap nodelist in proxy to log queries and wrap returned nodes
                                  var p = new Proxy( retVal, nodelist_handler );
                                  Object.defineProperty(p, '_base', {
                                      enumerable: false,
                                      configurable: false,
                                      writable: false,
                                      value: retVal
                                  });
                                  console.log( "Call to document.getElementsByName() in " + caller + "; args=" + requested_name +
                                  "; returned_nodes_child_paths=" + list_properties_array(ret[0]) + "; child_path_tags=" +
                                  list_properties_array(ret[1]));
                                  return p;
                              };

    var _getElementsByClassName = document.getElementsByClassName;
    document.getElementsByClassName = function(requested_class){
                                  // log the method name, argument (name), returned list of children (path for each)
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _getElementsByClassName.call(document, requested_class);
                                  var ret = get_multi_child_path(retVal);
                                  // wrap nodelist in proxy to log queries and wrap returned nodes
                                  var p = new Proxy( retVal, nodelist_handler );
                                  Object.defineProperty(p, '_base', {
                                      enumerable: false,
                                      configurable: false,
                                      writable: false,
                                      value: retVal
                                  });
                                  console.log( "Call to document.getElementsByClassName() in " + caller + "; args=" + requested_class +
                                  "; returned_nodes_child_paths=" + list_properties_array(ret[0]) + "; child_path_tags=" +
                                  list_properties_array(ret[1]));
                                  return p;
                              };


    var _getElementsByTagName = document.getElementsByTagName;
    document.getElementsByTagName = function(requested_tag){
                                  // log the method name, argument (name), returned list of children (path for each)
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _getElementsByTagName.call(document, requested_tag);
                                  var ret = get_multi_child_path(retVal);
                                  // wrap nodelist in proxy to log queries and wrap returned nodes
                                  var p = new Proxy( retVal, nodelist_handler );
                                  Object.defineProperty(p, '_base', {
                                      enumerable: false,
                                      configurable: false,
                                      writable: false,
                                      value: retVal
                                  });
                                  console.log( "Call to document.getElementsByTagName() in " + caller + "; args=" + requested_tag +
                                  "; returned_nodes_child_paths=" + list_properties_array(ret[0]) + "; child_path_tags=" +
                                  list_properties_array(ret[1]));
                                  return p;
                              };

    var _querySelectorAll = document.querySelectorAll;
    document.querySelectorAll = function(requested_selector){
                                  // log the method name, argument (selector name), returned list of children (path for each)
                                  // returns the nodes in top-to-bottom order (any match)---not in order of selectors
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _querySelectorAll.call(document, requested_selector);
                                  var ret = get_multi_child_path(retVal);
                                  // wrap nodelist in proxy to log queries and wrap returned nodes
                                  var p = new Proxy( retVal, nodelist_handler );
                                  Object.defineProperty(p, '_base', {
                                      enumerable: false,
                                      configurable: false,
                                      writable: false,
                                      value: retVal
                                  });
                                  console.log( "Call to document.querySelectorAll() in " + caller + "; args=" + requested_selector +
                                  "; returned_nodes_child_paths=" + list_properties_array(ret[0]) + "; child_path_tags=" +
                                  list_properties_array(ret[1]));
                                  return p;
                              };

    var _getElementsByTagNameNS = document.getElementsByTagNameNS;
    document.getElementsByTagNameNS = function(namespace, requested_tag){
                                  // log the method name, argument (name), returned list of children (path for each)
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _getElementsByTagNameNS.call(document, namespace, requested_tag);
                                  var ret = get_multi_child_path(retVal);
                                  // wrap nodelist in proxy to log queries and wrap returned nodes
                                  var p = new Proxy( retVal, nodelist_handler );
                                  Object.defineProperty(p, '_base', {
                                      enumerable: false,
                                      configurable: false,
                                      writable: false,
                                      value: retVal
                                  });
                                  console.log( "Call to document.getElementsByTagNameNS() in " + caller + "; args=" + namespace + "," + requested_tag +
                                  "; returned_nodes_child_paths=" + list_properties_array(ret[0]) + "; child_path_tags=" +
                                  list_properties_array(ret[1]));
                                  return p;
                              };

    var _adoptNode = document.adoptNode;
    document.adoptNode = function(newnode){
                                  // tests whether comparenode and this node are equal (return bool)
                                  var arg1_val = newnode;
                                  var arg1_id = "null";
                                  if ( newnode.hasOwnProperty("_id") ) {
                                      arg1_id = newnode._id;
                                      arg1_val = newnode._base;
                                  }
                                  var caller = get_caller(document.currentScript);
                                  var child_vals = get_child_path(arg1_val);
                                  var retVal = _adoptNode.call(document, arg1_val);
                                  console.log( "Call to document.adoptNode() in " + caller + "; arg_ids="+
                                               arg1_id + "; arg_node_child_path=" + child_vals[0] +
                                               "; child_path_tags=" + child_vals[1]);
                                  return retVal;
                              };


    var _caretPositionFromPoint = document.caretPositionFromPoint;
    document.caretPositionFromPoint = function(x, y){
                                  // log the method name, argument (name), returned list of children (path for each)
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _caretPositionFromPoint.call(document, x, y);
                                  // wrap caretPosition in proxy to log offsetNode call and wrap returned nodes
                                  var p = new Proxy( retVal, caret_handler );
                                  console.log( "Call to document.caretPositionFromPoint() in " + caller + "; args=" + x + "," + y);
                                  return p;
                              };

    var _open = document.open;
    document.open = function(){
                                  // clears document if it exists---write on document, or handle with document proxy?
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _open.call(document);
                                  console.log( "Call to document.open() in " + caller);
                              };

    var _close = document.close;
    document.close = function(){
                                  // closes document---write on document, or handle with document proxy?
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _close.call(document);
                                  console.log( "Call to document.close() in " + caller);
                              };

    var _clear = document.clear;
    document.clear = function(){
                                  // clears document---write on document, or handle with document proxy?
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _clear.call(document);
                                  console.log( "Call to document.clear() in " + caller);
                              };

    var _createAttribute = document.createAttribute;
    document.createAttribute = function(name){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createAttribute.call(document, name);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createAttribute() in " + caller + "; args="+ name +
                                  "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createCDATASection = document.createCDATASection;
    document.createCDATASection = function(data){
                                  // only works with XML (HTML does not support CDATA sections)
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createCDATASection.call(document, data);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createCDATASection() in " + caller + "; args="+ data +
                                  "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createComment = document.createComment;
    document.createComment = function(data){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createComment.call(document, data);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createComment() in " + caller + "; args="+ data +
                                  "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createDocumentFragment = document.createDocumentFragment;
    document.createDocumentFragment = function(){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createDocumentFragment.call(document);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createDocumentFragment() in " + caller + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createElement = document.createElement;
    document.createElement = function(tagname){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createElement.call(document, tagname);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createElement() in " + caller + "; args=" + tagname
                                               + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createElementNS = document.createElementNS;
    document.createElementNS = function(namespaceURI, qualName){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createElementNS.call(document, namespaceURI, qualName);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createElementNS() in " + caller + "; args=" + namespaceURI
                                               + "," + qualName + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createTextNode = document.createTextNode;
    document.createTextNode = function(data){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createTextNode.call(document, data);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createTextNode() in " + caller + "; args=" + data
                                               + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createProcessingInstruction = document.caretProcessingInstruction;
    document.createProcessingInstruction = function(target, data){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _createProcessingInstruction.call(document, target, data);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.createProcessingInstruction() in " + caller + "; args=" + target
                                               + "," + data + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _elementFromPoint = document.elementFromPoint;
    document.elementFromPoint = function(x, y){
                                  // log the method name, argument (id name), returned node child path
                                  var caller = get_caller(document.currentScript);
                                  var retVal = _elementFromPoint.call(document, x, y);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.elementFromPoint() in " + caller + "; args=" + x
                                               + "," + y + "; ret_id = " + p[1]);
                                  return p[0];
                              };

    var _createNodeIterator = document.createNodeIterator;
    document.createNodeIterator = function(root, whatToShow, filter){
                                  // log the method name, argument (id name), returned node child path
                                  var arg1_id = "null";
                                  var arg1_val = root;
                                  if ( root.hasOwnProperty("_id") ) {
                                      arg1_id = root._id;
                                      arg1_val = root._base;
                                  }
                                  var caller = get_caller(document.currentScript);
                                  var retVal;
                                  if ( (whatToShow == undefined) && (filter == undefined) ) {
                                      retVal = _createNodeIterator.call(document, arg1_val);
                                  } else if ( whatToShow == undefined ) {
                                      var retVal = _createNodeIterator.call(document, arg1_val, filter);
                                  } else if ( filter == undefined ) {
                                      var retVal = _createNodeIterator.call(document, arg1_val, whatToShow);
                                  } else {
                                      var retVal = _createNodeIterator.call(document, arg1_val, whatToShow, filter);
                                  }
                                  var p = new Proxy( retVal, nodeiterator_handler );
                                  Object.defineProperty(p, '_base', {
                                      enumerable: false,
                                      configurable: false,
                                      writable: false,
                                      value: retVal
                                  });
                                  console.log( "Call to document.createNodeIterator() in " + caller + "; args=" + arg1_id
                                               + "," + whatToShow + "," + filter);
                                  return p;
                              };

    var _createNSResolver = document.createNSResolver;
    document.createNSResolver = function(node){
                                  var arg1_val = node;
                                  var arg1_id = "null";
                                  if ( node.hasOwnProperty("_id") ) {
                                      arg1_id = node._id;
                                      arg1_val = node._base;
                                  }
                                  var caller = get_caller(document.currentScript);
                                  var child_vals = get_child_path(arg1_val);
                                  var retVal = _createNSResolver.call(document, arg1_val);
                                  console.log( "Call to document.createNSResolver() in " + caller + "; arg_ids="+
                                               arg1_id + "; arg_node_child_path=" + child_vals[0] +
                                               "; child_path_tags=" + child_vals[1]);
                                  return retVal;
                              };


    var _importNode = document.importNode;
    document.importNode = function(node, deep){
                                  // tests whether comparenode and this node are equal (return bool)
                                  var arg1_val = node;
                                  var arg1_id = "null";
                                  if ( node.hasOwnProperty("_id") ) {
                                      arg1_id = node._id;
                                      arg1_val = node._base;
                                  }
                                  var caller = get_caller(document.currentScript);
                                  var child_vals = get_child_path(arg1_val);
                                  var retVal = _importNode.call(document, arg1_val, deep);
                                  var p = wrap_node_in_proxy(retVal);
                                  console.log( "Call to document.importNode() in " + caller + "; arg_ids="+
                                               arg1_id + "; arg_node_child_path=" + child_vals[0] +
                                               "; child_path_tags=" + child_vals[1] + "; ret_id=" + p[1]);
                                  return p[0];
                              };


    var _document = document;
    var documentBindCache = {};
    // document methods we have shims for---don't need document proxy to log
    document_shims = ["getElementById", "querySelector", "getElementsByName", "getElementsByClassName", "getElementsByTagName",
                      "querySelectorAll", "getElementsByTagNameNS", "adoptNode", "caretPositionFromPoint", "createAttribute",
                      "createCDATASection", "createComment", "createDocumentFragment", "createElement", "createElementNS",
                      "createTextNode", "createCaretProcessingInstruction", "elementFromPoint", "createNodeIterator",
                      "createNSResolver", "importNode"]
    var document_handler = {
        "get": function(base, name){
                   var caller = get_caller( document.currentScript);
                   var value = base[name];
                   if ( (name == "hasOwnProperty") || (name == "_id" ) ||
                        (name == "_base") || (document_shims.indexOf(name) != -1)) {
                       return value;
                   }
                   var log = {'OpType': 'READ', 'PropName': name, 'script': caller}
                   console.log(JSON.stringify( log  ) );
                   return value;
               },
        "set": function(base, name, value){
                   var caller = get_caller( document.currentScript);
                   var log = {'OpType': 'WRITE', 'PropName': name, 'script': caller}
                   console.log(JSON.stringify( log  ) );
                   base[name] = value;
               }
    };
}
</script>
